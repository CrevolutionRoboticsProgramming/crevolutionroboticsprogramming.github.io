<!DOCTYPE html>
<html>
    <head>
      <!-- Responsiveness -->
      <meta charset="UTF8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />

      <!-- Page Title -->
      <title>Crevolution - States</title>
       
      <!-- Link Assets & CSS -->
      <link rel="icon" href="/assets/img/logos/watermark.svg" type="image/png" sizes="16x16" />
      <link rel="stylesheet" href="/css/bootstrap.css">
      <link href="/css/index.css" rel="stylesheet" type="text/css" />
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap">
    </head>
<body>

  <!-- Link JS -->
  <script src="/js/bootstrap.js"></script>
  <script src="/js/jquery.js"></script>

  <!-- Navbar located in /assets/nav.html -->
  <div id="nav-placeholder">
  </div>
  <script>
  $(function(){
    $("#nav-placeholder").load("/assets/nav.html");
  });
  </script>
  <div class="jbo"> </div>
    <div id="mi25-tc" class="jb t-card">
      <div class="blktcbk">
      <h1 class="title">States 2025</h1>
      </div>
    </div>
    
  <div class="max-w-6xl mx-auto">
      <h1 class="heading">QUAL RECORD</h1>
      <h3 class="txtc"><span id="team-record">--</span></h3>
      <h1 class="heading">QUAL RANK</h1>
      <h3 class="txtc"><span id="team-rank" class="font-semibold text-white">--</span></h3>
  </div>

      
      <div id="match-schedule" class="match-list max-h-96 overflow-y-auto pr-2 space-y-3">
        <p class="text-center text-gray-500" id="match-loading-message">Loading match data...</p>
      </div>









      <script>
        // --- API Configuration ---
        const TEAM_KEY = 'frc2851';
        const EVENT_KEY = '2025micmp2';
        const API_KEY = 'azzCHBd2ABAiRH2wvlw8ThoDllzVGkpGCFnOCKq1XnNFWMyYMnJwWhn5ufNoGb7f';
        const BASE_URL = 'https://www.thebluealliance.com/api/v3';
        const HEADERS = { 'X-TBA-Auth-Key': API_KEY };
        const RETRY_LIMIT = 3;

        // --- Utility Functions ---

        /**
         * Converts TBA match type keys to readable names.
         * @param {string} key 
         */
        function getMatchType(key) {
            switch (key) {
                case 'qm': return 'QUAL';
                case 'qf': return 'PLAYOFF';
                case 'sf': return 'PLAYOFF';
                case 'f': return 'FINAL';
                case 'p': return 'PRACTICE';
                default: return 'Match';
            }
        }

        /**
         * Formats UTC timestamp into a readable local time string.
         * @param {number} timestamp 
         */
        function formatMatchTime(timestamp) {
            if (!timestamp) return 'Time TBD';
            const date = new Date(timestamp * 1000);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        /**
         * Handles the fetching logic with exponential backoff for resilience.
         * @param {string} endpoint The TBA API endpoint (e.g., '/team/frc2851/event/2025mibro/matches')
         * @param {number} attempt Current retry attempt count
         */
        async function fetchTBA(endpoint, attempt = 1) {
            const url = `${BASE_URL}${endpoint}`;
            const delay = Math.pow(2, attempt) * 100; // Exponential backoff: 200ms, 400ms, 800ms...

            try {
                const response = await fetch(url, { headers: HEADERS });

                if (response.status === 304) {
                    console.log(`[TBA Cache] Data for ${endpoint} has not changed.`);
                    return JSON.parse(localStorage.getItem(endpoint)); // Retrieve from cache if not modified
                }

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Cache the successful response for 304 handling if using ETag/If-None-Match headers (TBA recommended)
                // Note: The simple fetch above doesn't implement If-None-Match, but this simulates the concept.
                localStorage.setItem(endpoint, JSON.stringify(data)); 
                return data;

            } catch (error) {
                if (attempt < RETRY_LIMIT) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchTBA(endpoint, attempt + 1);
                } else {
                    throw new Error(`Failed to fetch ${endpoint} after ${RETRY_LIMIT} attempts. ${error.message}`);
                }
            }
        }

        /**
         * Renders an individual match block.
         * @param {object} match 
         */
        function renderMatch(match) {
            const is2851Red = match.alliances.red.team_keys.includes(TEAM_KEY);
            const is2851Blue = match.alliances.blue.team_keys.includes(TEAM_KEY);
            const allianceClass = is2851Red ? 'crevo' : 
                                   is2851Blue ? 'crevo' : 
                                   'crevo';

            const matchType = getMatchType(match.comp_level);
            const matchTime = formatMatchTime(match.time);
            const redScore = match.alliances.red.score === -1 ? 'TBD' : match.alliances.red.score;
            const blueScore = match.alliances.blue.score === -1 ? 'TBD' : match.alliances.blue.score;
            const hasPlayed = redScore !== 'TBD' || match.actual_time > 0;
            const resultClass = hasPlayed ? (is2851Red && redScore > blueScore) || (is2851Blue && blueScore > redScore) ? 'text-green-400 font-bold' : 'text-red-400 font-bold' : 'text-gray-400';
            const resultText = hasPlayed ? ((is2851Red && redScore > blueScore) || (is2851Blue && blueScore > redScore) ? 'WIN' : 'LOSS') : 'Upcoming';
            const teamsToString = (keys) => keys.map(k => `<span class="${k === TEAM_KEY ? 'crevo' : 'text-gray-300'}">${k.substring(3)}</span>`).join('');

            // --- NEW LOGIC FOR VIDEO LINK ---
            let videoLink = '';
            const youtubeVideo = match.videos?.find(v => v.type === 'youtube');
            const videoId = youtubeVideo ? youtubeVideo.key : null;

            if (videoId) {
                const url = `https://www.youtube.com/watch?v=${videoId}`;
                // Wrap the title in an anchor tag with click styling and a YouTube icon (simple SVG for a play button)
                videoLink = `<a href="${url}" target="_blank" class="text-blue-300 hover:text-blue-200 hover:underline transition-colors duration-200 flex items-center group">
                                <span>${matchType} ${match.match_number}</span>
                                </a>`;
            } else {
                videoLink = `<span>${matchType} ${match.match_number}</span>`;
            }
            // ------------------------------------

            return `
            <div class="game"><div class="gamebar"><div class="alliance red-all aaflex">
        <p class="aaflex">${teamsToString(match.alliances.red.team_keys)}</p>
      </div><div class="red-all-score all-score">
        <h1>${redScore}</h1>
      </div><div class="middle-area">
        <p>${videoLink}</p>
        <p>CREVO ${resultText}</p>
      </div><div class="blue-all-score all-score">
        <h1>${blueScore}</h1>
      </div><div class="alliance blue-all aaflex">
        <p class="aaflex">${teamsToString(match.alliances.blue.team_keys)}</p>
            `;
        }

        /**
         * Fetches and displays Team 2851's current event status (rank/record) and event title.
         */
                async function loadStatus() {
            try {
                // Fetch Event Details for Title
                const eventDetails = await fetchTBA(`/event/${EVENT_KEY}`);
                const eventTitleElement = document.getElementById('event-title');
                
                // Add null check for robustness, although it should exist
                if (eventTitleElement) {
                    if (eventDetails && eventDetails.name) {
                        eventTitleElement.textContent = eventDetails.name;
                    } else {
                        eventTitleElement.textContent = 'Event Details N/A';
                    }
                }

                // Fetch Team Status
                const status = await fetchTBA(`/team/${TEAM_KEY}/event/${EVENT_KEY}/status`);

                if (!status) {
                    document.getElementById('team-rank').textContent = 'N/A';
                    document.getElementById('team-record').textContent = 'N/A';
                    return;
                }

                // Status/Rank Data
                document.getElementById('team-rank').textContent = status.qual?.ranking?.rank || 'N/A';
                document.getElementById('team-record').textContent = `${status.qual?.ranking?.record?.wins || 0}-${status.qual?.ranking?.record?.losses || 0}-${status.qual?.ranking?.record?.ties || 0}`;
                document.getElementById('team-score').textContent = status.qual?.ranking?.sort_order_info?.[0]?.sort_value?.toFixed(2) || 'N/A';

                // Playoff Status
                const playoffText = status.playoff?.status ? 
                    `${status.playoff.status.toUpperCase()} (${status.playoff.level.toUpperCase()})` : 
                    status.status.toUpperCase();
                document.getElementById('playoff-status').textContent = playoffText;

            } catch (error) {
                console.error('Error loading status:', error);
                // Attempt to update status fields in case of fetch error
                const teamRank = document.getElementById('team-rank');
                if (teamRank) teamRank.textContent = 'API Error';
            }
        }

        /**
         * Fetches and displays Team 2851's match schedule.
         */
        async function loadMatches() {
            const matchesContainer = document.getElementById('match-schedule');
            // FIX: Move 'now' definition outside of the conditional block to ensure it's always in scope
            const now = Math.floor(Date.now() / 1000); 
            
            try {
                // Fetch ALL matches for the event that 2851 participated in
                const allMatches = await fetchTBA(`/team/${TEAM_KEY}/event/${EVENT_KEY}/matches`);

                // Filter for Qualification (qm) and Elimination (qf, sf, f) matches, 
                // and sort by scheduled time in DESCENDING order (newest on top)
                const filteredMatches = allMatches
                    .filter(m => m.comp_level !== 'p') // Filter out practice matches
                    .sort((a, b) => b.time - a.time); // Newest matches (highest time) first

                if (matchesContainer) {
                    matchesContainer.innerHTML = ''; // Clear loading message

                    if (filteredMatches.length === 0) {
                        matchesContainer.innerHTML = '<p class="text-center text-gray-500">No official matches found for this event yet.</p>';
                        return;
                    }

                    // 'now' definition removed from here
                    
                    filteredMatches.forEach(match => {
                        matchesContainer.innerHTML += renderMatch(match);
                    });
                }
                
                // Calculate next match time by finding the *earliest* match in the future (sort ASC)
                const nextMatch = allMatches
                    .filter(m => m.comp_level !== 'p' && m.time > now)
                    .sort((a, b) => a.time - b.time)[0]; 

                const nextMatchTime = nextMatch ? formatMatchTime(nextMatch.time) : 'N/A';


            } catch (error) {
                console.error('Error loading matches:', error);
                if (matchesContainer) {
                    matchesContainer.innerHTML = `<p class="text-center text-red-400">Failed to load schedule: ${error.message}.</p>`;
                }
            }
        }

        /**
         * Initialization function
         */
        async function initDashboard() {
            try {
                await loadStatus();
                await loadMatches();

                // Hide loading indicator and show content
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                
                const content = document.getElementById('content');
                if (content) content.classList.remove('hidden');

            } catch (error) {
                // Handle critical failure with robust null checks
                console.error('Critical initialization error:', error);
                
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.classList.add('hidden');
                }

                const errorDetails = document.getElementById('error-details');
                if (errorDetails) {
                    errorDetails.textContent = error.message || 'An unknown error occurred during initialization.';
                }
                
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) {
                    errorMessage.classList.remove('hidden');
                }
            }
        }


        // Start the application
        window.onload = initDashboard;
    </script>

      <div id="overview">
        <p class="award"><i class="bi bi-trophy-fill"></i> NAN </p>
      </div>
     <!-- Footer located in /assets/ftr.html -->
  <div id="ftr-placeholder">
  </div>
  <script>
  $(function(){
    $("#ftr-placeholder").load("/assets/ftr.html");
  });
  </script>

</body>
</html>